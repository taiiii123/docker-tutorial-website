# ネットワークの種類

## 概要

このセクションでは、Dockerで使用できる様々なネットワークドライバーの種類と、それぞれの特徴・ユースケースを学びます。

## ネットワークドライバーの種類

Dockerは複数のネットワークドライバーを提供しており、用途に応じて使い分けます。

| ドライバー | 説明 | 主なユースケース |
|-----------|------|-----------------|
| bridge | 同一ホスト上のコンテナ間通信（デフォルト） | 単一ホストでの開発・テスト |
| host | ホストのネットワークを直接使用 | パフォーマンスが重要な場合 |
| none | ネットワーク接続なし | セキュリティ重視、バッチ処理 |
| overlay | 複数ホスト間のコンテナ通信 | Docker Swarm、マルチホスト構成 |
| macvlan | コンテナに物理MACアドレスを割り当て | レガシーアプリケーション連携 |
| ipvlan | IPベースのネットワーク分離 | 高度なネットワーク要件 |

## bridgeネットワーク

### 概要

**bridgeネットワーク**は、同一ホスト上で動作するコンテナ間の通信を可能にする最も一般的なネットワークタイプです。

### デフォルトbridgeの特徴

```bash
# デフォルトbridgeネットワークの確認
docker network inspect bridge
```

| 特徴 | 説明 |
|------|------|
| 自動接続 | `--network` 指定なしで起動したコンテナが接続 |
| IPアドレス | 172.17.0.0/16 サブネットから自動割り当て |
| コンテナ間通信 | IPアドレスでのみ通信可能（DNS解決なし） |

### デフォルトbridgeの制限

```bash
# 2つのコンテナを起動
docker run -d --name container1 alpine sleep 3600
docker run -d --name container2 alpine sleep 3600

# IPアドレスでの通信は可能
docker exec container1 ping -c 2 172.17.0.3

# しかし、コンテナ名での通信は不可
docker exec container1 ping -c 2 container2
# ping: bad address 'container2'

# クリーンアップ
docker stop container1 container2
docker rm container1 container2
```

### ユーザー定義bridgeネットワーク

デフォルトbridgeの制限を解決するため、**ユーザー定義bridgeネットワーク**の使用が推奨されます。

```bash
# カスタムbridgeネットワークを作成
docker network create my-network

# ネットワークを指定してコンテナを起動
docker run -d --name container1 --network my-network alpine sleep 3600
docker run -d --name container2 --network my-network alpine sleep 3600

# コンテナ名で通信可能
docker exec container1 ping -c 2 container2
# PING container2 (172.18.0.3): 56 data bytes
# 64 bytes from 172.18.0.3: seq=0 ttl=64 time=0.123 ms

# クリーンアップ
docker stop container1 container2
docker rm container1 container2
docker network rm my-network
```

### bridgeネットワークの構造

```
┌─────────────────────────────────────────────────────┐
│                    ホストマシン                       │
│                                                       │
│  ┌───────────────────────────────────────────────┐  │
│  │          User-defined Bridge (my-network)      │  │
│  │                   172.18.0.1                   │  │
│  │         ┌──────────────────────────┐          │  │
│  │         │     内蔵DNSサーバー        │          │  │
│  │         │  container1 → 172.18.0.2  │          │  │
│  │         │  container2 → 172.18.0.3  │          │  │
│  │         └──────────────────────────┘          │  │
│  └──────────┬────────────────┬───────────────────┘  │
│             │                │                       │
│    ┌────────┴───────┐ ┌─────┴──────────┐           │
│    │  container1    │ │   container2    │           │
│    │  172.18.0.2    │ │   172.18.0.3    │           │
│    └────────────────┘ └────────────────┘           │
│                                                       │
└─────────────────────────────────────────────────────┘
```

## hostネットワーク

### 概要

**hostネットワーク**を使用すると、コンテナはホストマシンのネットワークスタックを直接共有します。

### 特徴

| 特徴 | 説明 |
|------|------|
| ネットワーク分離なし | コンテナはホストのIPアドレスを使用 |
| ポートマッピング不要 | コンテナのポートがホストで直接利用可能 |
| 高パフォーマンス | NATのオーバーヘッドがない |
| Linux専用 | macOSやWindowsでは動作が異なる |

### 使用例

```bash
# hostネットワークでNginxを起動
docker run -d --name nginx-host --network host nginx

# ポートマッピングなしでアクセス可能
curl http://localhost:80

# ホストのネットワーク設定を確認（コンテナ内から）
docker exec nginx-host ip addr

# クリーンアップ
docker stop nginx-host && docker rm nginx-host
```

### hostネットワークの構造

```
┌─────────────────────────────────────────────────────┐
│                    ホストマシン                       │
│                   IP: 192.168.1.100                  │
│                                                       │
│    ┌─────────────────────────────────────────────┐  │
│    │                 コンテナ                      │  │
│    │          (hostネットワーク使用)              │  │
│    │           ホストのIPを直接使用               │  │
│    │             192.168.1.100:80                │  │
│    └─────────────────────────────────────────────┘  │
│                                                       │
│    eth0: 192.168.1.100                              │
│                                                       │
└─────────────────────────────────────────────────────┘
                      │
                      ▼
              外部ネットワーク
```

### ユースケース

- ネットワークパフォーマンスが最重要な場合
- 動的ポートを使用するアプリケーション
- ネットワーク監視ツール

### 注意点

```bash
# hostネットワークではポートマッピングは無視される
docker run -d --network host -p 8080:80 nginx
# 警告: -p オプションは host ネットワークモードでは無視されます
```

## noneネットワーク

### 概要

**noneネットワーク**は、コンテナを完全にネットワークから隔離します。

### 特徴

```bash
# noneネットワークでコンテナを起動
docker run -d --name isolated --network none alpine sleep 3600

# ネットワークインターフェースを確認
docker exec isolated ip addr
# 出力: lo（ループバック）のみ

# 外部への通信は不可
docker exec isolated ping -c 2 8.8.8.8
# ping: sendto: Network is unreachable

# クリーンアップ
docker stop isolated && docker rm isolated
```

### ユースケース

| ユースケース | 説明 |
|-------------|------|
| セキュリティ | ネットワークアクセスを完全に遮断 |
| バッチ処理 | ネットワーク不要な処理 |
| 機密データ処理 | データ漏洩リスクの最小化 |

## overlayネットワーク

### 概要

**overlayネットワーク**は、複数のDockerホスト間でコンテナ通信を可能にします。Docker SwarmやKubernetesなどのオーケストレーション環境で使用されます。

### 特徴

| 特徴 | 説明 |
|------|------|
| マルチホスト | 異なるホスト上のコンテナが通信可能 |
| 暗号化 | オプションでトラフィックを暗号化 |
| サービス検出 | 組み込みのDNSによるサービス検出 |

### overlayネットワークの構造

```
┌─────────────────────────────────────────────────────────────────┐
│                      Overlay Network                             │
│                                                                   │
│  ┌─────────────────────┐        ┌─────────────────────┐        │
│  │      Host 1          │        │      Host 2          │        │
│  │                       │        │                       │        │
│  │  ┌───────────────┐   │        │   ┌───────────────┐   │        │
│  │  │  Container A  │   │◄──────►│   │  Container B  │   │        │
│  │  │  10.0.0.2     │   │ VXLAN  │   │  10.0.0.3     │   │        │
│  │  └───────────────┘   │        │   └───────────────┘   │        │
│  │                       │        │                       │        │
│  └─────────────────────┘        └─────────────────────┘        │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 基本的な使用方法（Swarmモード）

```bash
# Swarmモードを初期化（シングルノードでの例）
docker swarm init

# overlayネットワークを作成
docker network create --driver overlay my-overlay

# ネットワークの確認
docker network ls --filter driver=overlay

# Swarmモードを終了する場合
docker swarm leave --force
```

## macvlanネットワーク

### 概要

**macvlanネットワーク**は、コンテナに独自のMACアドレスを割り当て、物理ネットワーク上の独立したデバイスとして見せることができます。

### 特徴

```bash
# macvlanネットワークの作成例
docker network create -d macvlan \
  --subnet=192.168.1.0/24 \
  --gateway=192.168.1.1 \
  -o parent=eth0 \
  my-macvlan

# macvlanネットワークでコンテナを起動
docker run -d --name web --network my-macvlan nginx
```

### ユースケース

- レガシーアプリケーションとの統合
- 物理ネットワーク上で独立したIPが必要な場合
- VLANとの連携

## ネットワークドライバーの比較

```
┌──────────────────────────────────────────────────────────────────┐
│                    ネットワークドライバー比較                      │
├─────────┬───────────┬────────────┬───────────┬─────────────────┤
│ドライバー │ 分離レベル │パフォーマンス│ スケール  │    用途         │
├─────────┼───────────┼────────────┼───────────┼─────────────────┤
│ bridge  │    中     │    良好    │ シングル  │ 開発・小規模     │
├─────────┼───────────┼────────────┼───────────┼─────────────────┤
│ host    │    低     │   最高     │ シングル  │ パフォーマンス重視 │
├─────────┼───────────┼────────────┼───────────┼─────────────────┤
│ none    │    最高   │    N/A     │    N/A    │ セキュリティ     │
├─────────┼───────────┼────────────┼───────────┼─────────────────┤
│ overlay │    中     │    良好    │ マルチ   │ クラスタ環境     │
├─────────┼───────────┼────────────┼───────────┼─────────────────┤
│ macvlan │    高     │   最高     │ シングル  │ レガシー連携     │
└─────────┴───────────┴────────────┴───────────┴─────────────────┘
```

## まとめ

- **bridge**: デフォルトのネットワーク、同一ホスト上でのコンテナ間通信に使用
- **host**: ホストのネットワークスタックを直接使用、高パフォーマンスが必要な場合に有効
- **none**: ネットワーク接続なし、セキュリティ重視の場合に使用
- **overlay**: 複数ホスト間でのコンテナ通信、Swarmやクラスタ環境で使用
- **macvlan**: 物理ネットワーク上の独立したデバイスとして動作、レガシーシステム連携に有効
- ユーザー定義bridgeネットワークはデフォルトbridgeより多くの機能（DNS解決など）を提供

次のセクションでは、カスタムネットワークの作成方法について詳しく学びます。
