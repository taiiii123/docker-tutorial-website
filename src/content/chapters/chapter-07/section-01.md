# コンテナセキュリティの基礎

## 概要

このセクションでは、Dockerコンテナのセキュリティの基本概念を学びます。コンテナの分離機構、脅威モデル、攻撃ベクター、そして安全なコンテナ運用に必要な基本原則について理解を深めます。

## コンテナの分離機構

Dockerコンテナは、Linuxカーネルの機能を利用してプロセスを分離しています。

### Namespace（名前空間）

Namespaceは、システムリソースを分離する仕組みです。

| Namespace | 分離対象 | 説明 |
|-----------|----------|------|
| PID | プロセスID | コンテナ内のプロセスが独自のPID空間を持つ |
| Network | ネットワーク | 独立したネットワークスタック |
| Mount | ファイルシステム | 独立したマウントポイント |
| UTS | ホスト名 | 独立したホスト名とドメイン名 |
| IPC | プロセス間通信 | 独立したIPC空間 |
| User | ユーザーID | ユーザーとグループIDのマッピング |

```bash
# コンテナのNamespaceを確認
docker inspect --format='{{.State.Pid}}' my-container

# ホストからコンテナのNamespaceを確認（Linux）
ls -la /proc/<PID>/ns/
```

### cgroups（コントロールグループ）

cgroupsは、プロセスが使用するリソースを制限・監視する仕組みです。

```
┌─────────────────────────────────────────────────────┐
│                    ホストマシン                      │
├─────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │ Container A │  │ Container B │  │ Container C │ │
│  │ CPU: 50%    │  │ CPU: 25%    │  │ CPU: 25%    │ │
│  │ Mem: 512MB  │  │ Mem: 256MB  │  │ Mem: 256MB  │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
│                                                     │
│  cgroups によるリソース制限                          │
└─────────────────────────────────────────────────────┘
```

## 脅威モデルと攻撃ベクター

コンテナ環境には、さまざまなセキュリティリスクが存在します。

### 主な攻撃ベクター

```
┌─────────────────────────────────────────────────────────────┐
│                      攻撃ベクター                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 悪意のあるイメージ                                        │
│     └─→ マルウェア混入、バックドア、脆弱なライブラリ           │
│                                                             │
│  2. コンテナからのエスケープ                                  │
│     └─→ カーネル脆弱性、設定ミス、過剰な権限                  │
│                                                             │
│  3. ネットワーク攻撃                                         │
│     └─→ 不要なポート公開、コンテナ間通信                      │
│                                                             │
│  4. シークレット漏洩                                         │
│     └─→ 環境変数、イメージ内ハードコード                      │
│                                                             │
│  5. リソース枯渇攻撃（DoS）                                   │
│     └─→ CPU・メモリの過剰使用                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 脅威レベルと対策

| 脅威 | リスク | 対策 |
|------|--------|------|
| 悪意のあるイメージ | 高 | 信頼できるイメージのみ使用、脆弱性スキャン |
| コンテナエスケープ | 高 | 非rootユーザー、seccomp、AppArmor |
| ネットワーク攻撃 | 中 | ネットワーク分離、ファイアウォール |
| シークレット漏洩 | 高 | シークレット管理ツール使用 |
| リソース枯渇 | 中 | リソース制限の設定 |

## 最小権限の原則

セキュリティの基本は「最小権限の原則」です。必要最小限の権限のみを付与します。

### 実践例

```dockerfile
# 悪い例：root権限で実行
FROM node:20
WORKDIR /app
COPY . .
RUN npm install
CMD ["node", "server.js"]

# 良い例：非rootユーザーで実行
FROM node:20
WORKDIR /app
COPY --chown=node:node . .
RUN npm install
USER node
CMD ["node", "server.js"]
```

### 権限を最小化するポイント

1. **非rootユーザーで実行**: `USER`命令を使用
2. **読み取り専用ファイルシステム**: `--read-only`フラグ
3. **Capability の削除**: 不要なLinux Capabilityを削除
4. **特権モードを避ける**: `--privileged`を使用しない

```bash
# 読み取り専用でコンテナを起動
docker run --read-only --tmpfs /tmp nginx

# すべてのCapabilityを削除
docker run --cap-drop=ALL nginx

# 必要なCapabilityのみ追加
docker run --cap-drop=ALL --cap-add=NET_BIND_SERVICE nginx
```

## 多層防御（Defense in Depth）

1つの防御層が破られても、他の層で保護できるよう複数の防御策を講じます。

```
┌─────────────────────────────────────────────────────────────┐
│                     多層防御の構成                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   Layer 1: イメージセキュリティ                              │
│   ├─ 信頼できるベースイメージ                                │
│   ├─ 脆弱性スキャン                                         │
│   └─ 最小限のパッケージ                                      │
│                                                             │
│   Layer 2: コンテナランタイム                                │
│   ├─ 非rootユーザー                                         │
│   ├─ 読み取り専用ファイルシステム                            │
│   └─ Capability制限                                         │
│                                                             │
│   Layer 3: ネットワーク                                      │
│   ├─ ネットワーク分離                                        │
│   ├─ 暗号化通信                                             │
│   └─ ファイアウォール                                        │
│                                                             │
│   Layer 4: ホストOS                                         │
│   ├─ SELinux/AppArmor                                       │
│   ├─ seccomp                                                │
│   └─ OSのセキュリティ更新                                    │
│                                                             │
│   Layer 5: 監視・監査                                        │
│   ├─ ログ収集                                               │
│   ├─ 異常検知                                               │
│   └─ セキュリティ監査                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## セキュリティ設定の確認

```bash
# コンテナのセキュリティ設定を確認
docker inspect --format='{{json .HostConfig.SecurityOpt}}' my-container

# 実行中のユーザーを確認
docker exec my-container whoami

# Capabilityを確認
docker exec my-container cat /proc/1/status | grep Cap
```

## Docker Desktopのセキュリティ設定

Docker Desktopでは、GUIからセキュリティ設定を確認・変更できます。

### Enhanced Container Isolation（拡張コンテナ分離）

Docker Desktop Pro/Business では、より強力な分離機能が利用できます。

- Sysbox ランタイムによる強化された分離
- rootlessモードのサポート
- セキュリティスキャンの統合

## まとめ

- コンテナはNamespaceとcgroupsで分離されているが、完全な分離ではない
- 主な攻撃ベクターを理解し、適切な対策を講じることが重要
- 最小権限の原則を徹底し、不要な権限を付与しない
- 多層防御で複数のセキュリティ層を構築する
- 定期的なセキュリティ監査と更新が必要

次のセクションでは、非rootユーザーでのコンテナ実行について詳しく学びます。
